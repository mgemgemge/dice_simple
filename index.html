<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Dice Duel</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      padding: 40px;
      background: #f0f0f0;
    }
    button {
      padding: 15px 30px;
      font-size: 20px;
      margin: 20px;
      border: none;
      background: #3b82f6;
      color: white;
      border-radius: 10px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h2>üé≤ Dice Duel</h2>
  <p id="welcome">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
  <p id="balance" style="font-size: 20px; font-weight: bold; color: #eab308;">üí∞ –ë–∞–ª–∞–Ω—Å: 500 –º–æ–Ω–µ—Ç</p>
  <button id="roll">–ë—Ä–æ—Å–∏—Ç—å –∫—É–±–∏–∫</button>
  <button id="challenge" style="background: #ef4444;">–í—ã–∑–≤–∞—Ç—å –¥—Ä—É–≥–∞</button>
  <div id="result"></div>

<script type="module">
  // –ü–æ–¥–∫–ª—é—á–∞–µ–º Supabase
  import { createClient } from 'https://esm.sh/@supabase/supabase-js';

  const supabase = createClient(
    'https://jcmckitvoqbuljadcfev.supabase.co',   // ‚Üê –∑–∞–º–µ–Ω–∏!
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpjbWNraXR2b3FidWxqYWRjZmV2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE4NTYxMDIsImV4cCI6MjA3NzQzMjEwMn0.JI5Y2-cSxgGB-j9LtczU5vENrYhSS4Q_EeLAYLauDBU'                          // ‚Üê –∑–∞–º–µ–Ω–∏!
  );

  const initData = window.Telegram.WebApp.initDataUnsafe;
  const user = initData?.user;
  const userId = user?.id.toString();
  const username = user?.username || user?.first_name || '–¥—Ä—É–≥';
  const startParam = initData?.start_param;

  document.getElementById('welcome').textContent = `–ü—Ä–∏–≤–µ—Ç, ${username}!`;

  // –ë–∞–ª–∞–Ω—Å
  let balance = 500;
  if (localStorage.getItem('dice_balance')) {
    balance = Number(localStorage.getItem('dice_balance'));
  } else {
    localStorage.setItem('dice_balance', '500');
  }
  document.getElementById('balance').textContent = `üí∞ –ë–∞–ª–∞–Ω—Å: ${balance} –º–æ–Ω–µ—Ç`;

  // –ï—Å–ª–∏ —ç—Ç–æ –¥—É—ç–ª—å –ø–æ ID
  if (startParam && !startParam.startsWith('duel_') && startParam.length === 8) {
    loadDuel(startParam);
  }

  // –í—ã–∑–æ–≤ –¥—Ä—É–≥–∞ ‚Üí —Å–æ–∑–¥–∞—ë–º –¥—É—ç–ª—å
  document.getElementById('challenge').onclick = async () => {
    const betStr = prompt('–°–∫–æ–ª—å–∫–æ –º–æ–Ω–µ—Ç –ø–æ—Å—Ç–∞–≤–∏—Ç—å? (–ú–∏–Ω–∏–º—É–º: 10)');
    const bet = parseInt(betStr);

    if (!betStr || isNaN(bet) || bet < 10 || bet > balance) {
      alert('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Å—Ç–∞–≤–∫–∞ –∏–ª–∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç!');
      return;
    }

    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–æ—Ä–æ—Ç–∫–∏–π ID (8 —Å–∏–º–≤–æ–ª–æ–≤)
    const id = Math.random().toString(36).substring(2, 10);
    await supabase.from('duels').insert({
      id,
      player_a: userId,
      bet,
      status: 'waiting'
    });

    const BOT_NAME = 'kostochki_game_bot';
    let mention = user?.first_name || '–ò–≥—Ä–æ–∫';
    if (user?.username) mention = `@${user.username}`;

    const message = `${mention} –≤—ã–∑—ã–≤–∞–µ—Ç –Ω–∞ –¥—É—ç–ª—å! –°—Ç–∞–≤–∫–∞: ${bet} –º–æ–Ω–µ—Ç üé≤\n\n–ò–≥—Ä–∞—Ç—å: https://t.me/${BOT_NAME}?startapp=${id}`;

    navigator.clipboard.writeText(message).then(() => {
      alert('‚úÖ –°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞! –û—Ç–ø—Ä–∞–≤—å –¥—Ä—É–≥—É.');
    });
  };

  async function loadDuel(duelId) {
    const { data, error } = await supabase
      .from('duels')
      .select('*')
      .eq('id', duelId)
      .single();

    if (error || !data) {
      document.getElementById('welcome').textContent = '–î—É—ç–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.';
      return;
    }

    if (data.player_a === userId) {
      document.getElementById('welcome').textContent = '–¢—ã —É–∂–µ —Å–æ–∑–¥–∞–ª —ç—Ç—É –¥—É—ç–ª—å!';
      return;
    }

    if (data.status === 'waiting') {
      document.getElementById('welcome').innerHTML = `–í—ã–∑–æ–≤ –æ—Ç –∏–≥—Ä–æ–∫–∞!<br>–°—Ç–∞–≤–∫–∞: ${data.bet} –º–æ–Ω–µ—Ç`;
      document.getElementById('roll').style.display = 'none';
      document.getElementById('challenge').style.display = 'none';

      const acceptBtn = document.createElement('button');
      acceptBtn.textContent = '–ü—Ä–∏–Ω—è—Ç—å –¥—É—ç–ª—å';
      acceptBtn.style.cssText = 'padding:15px 30px;font-size:20px;margin:20px;border:none;background:#10b981;color:white;border-radius:10px;cursor:pointer;';
      acceptBtn.onclick = async () => {
        // –ü—Ä–∏–Ω–∏–º–∞–µ–º –¥—É—ç–ª—å
        const { error: updError } = await supabase
          .from('duels')
          .update({ player_b: userId, status: 'active' })
          .eq('id', duelId)
          .eq('status', 'waiting');

        if (updError) {
          alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–∏–Ω—è—Ç—å –¥—É—ç–ª—å (–≤–æ–∑–º–æ–∂–Ω–æ, —É–∂–µ –ø—Ä–∏–Ω—è—Ç–∞)');
          return;
        }

        // –ù–∞—á–∏–Ω–∞–µ–º –∏–≥—Ä—É
        startRealDuel(data.bet, duelId);
      };
      document.body.appendChild(acceptBtn);
    }
  }

  async function startRealDuel(bet, duelId) {
    // –ó–¥–µ—Å—å –±—É–¥–µ—Ç –ª–æ–≥–∏–∫–∞ 3 —Ä–∞—É–Ω–¥–æ–≤ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
    alert(`–î—É—ç–ª—å –Ω–∞ ${bet} –º–æ–Ω–µ—Ç –Ω–∞—á–∞–ª–∞—Å—å! (–†–µ–∞–ª–∏–∑–∞—Ü–∏—è ‚Äî –≤ —Å–ª–µ–¥—É—é—â–µ–º —à–∞–≥–µ)`);
  }

  // –û–±—ã—á–Ω—ã–π –±—Ä–æ—Å–æ–∫
  document.getElementById('roll').onclick = () => {
    const dice = Math.floor(Math.random() * 6) + 1;
    document.getElementById('result').innerHTML = `<h1>–í—ã–ø–∞–ª–æ: ${dice}!</h1>`;
    if (window.navigator.vibrate) window.navigator.vibrate(100);
  };

  Telegram.WebApp.ready();
</script>
</body>
</html>
