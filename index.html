<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Dice Duel</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      padding: 20px;
      background: #f0f0f0;
      margin: 0;
    }
    button {
      padding: 14px 28px;
      font-size: 18px;
      margin: 12px 0;
      border: none;
      border-radius: 10px;
      cursor: pointer;
    }
    #mainBtns { margin-top: 20px; }
    .blue { background: #3b82f6; color: white; }
    .red { background: #ef4444; color: white; }
    .green { background: #10b981; color: white; }
    input {
      padding: 12px;
      font-size: 18px;
      width: 180px;
      margin: 10px 8px;
      border: 1px solid #ccc;
      border-radius: 8px;
    }
    #betInput { display: none; }
  </style>
</head>
<body>
  <h2>üé≤ Dice Duel</h2>
  <p id="welcome">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
  <p id="balance">üí∞ –ë–∞–ª–∞–Ω—Å: ‚Äî –º–æ–Ω–µ—Ç</p>

  <div id="mainBtns">
    <button id="roll" class="blue">–ë—Ä–æ—Å–∏—Ç—å –∫—É–±–∏–∫</button>
    <button id="challenge" class="red">–í—ã–∑–≤–∞—Ç—å –¥—Ä—É–≥–∞</button>
  </div>

  <div id="betInput">
    <input type="number" id="betAmount" placeholder="–°—Ç–∞–≤–∫–∞ (–º–∏–Ω. 10)" min="10">
    <br>
    <button id="confirmBet" class="green">–°–æ–∑–¥–∞—Ç—å –¥—É—ç–ª—å</button>
    <button id="cancelBet" class="blue">–û—Ç–º–µ–Ω–∞</button>
  </div>

  <div id="result"></div>

  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      const welcomeEl = document.getElementById('welcome');
      const balanceEl = document.getElementById('balance');

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–ø—É—â–µ–Ω–æ –ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤ Telegram
      if (!window.Telegram || !window.Telegram.WebApp || !window.Telegram.WebApp.initDataUnsafe) {
        welcomeEl.textContent = '‚ùå –û—Ç–∫—Ä–æ–π—Ç–µ –∏–≥—Ä—É —á–µ—Ä–µ–∑ Telegram!';
        balanceEl.style.display = 'none';
        document.getElementById('mainBtns').style.display = 'none';
        return;
      }

      const initData = window.Telegram.WebApp.initDataUnsafe;
      const user = initData.user;
      const userId = String(user.id);
      const username = user.username || user.first_name || '–¥—Ä—É–≥';

      // –ë–∞–ª–∞–Ω—Å
      let balance = localStorage.getItem('dice_balance');
      if (balance === null) {
        balance = 500;
        localStorage.setItem('dice_balance', '500');
      } else {
        balance = Number(balance);
      }

      welcomeEl.textContent = `–ü—Ä–∏–≤–µ—Ç, ${username}!`;
      balanceEl.textContent = `üí∞ –ë–∞–ª–∞–Ω—Å: ${balance} –º–æ–Ω–µ—Ç`;

      // –ü–æ–¥–∫–ª—é—á–∞–µ–º Supabase
      const supabase = window.supabase.createClient(
        'https://jcmckitvoqbuljadcfev.supabase.co',
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpjbWNraXR2b3FidWxqYWRjZmV2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE4NTYxMDIsImV4cCI6MjA3NzQzMjEwMn0.JI5Y2-cSxgGB-j9LtczU5vENrYhSS4Q_EeLAYLauDBU'
      );

      // === –ö–ù–û–ü–ö–ò ===

      // –ë—Ä–æ—Å–æ–∫ –∫—É–±–∏–∫–∞
      document.getElementById('roll').onclick = () => {
        const dice = Math.floor(Math.random() * 6) + 1;
        document.getElementById('result').innerHTML = `<h2>–í—ã–ø–∞–ª–æ: ${dice}!</h2>`;
        if (window.navigator.vibrate) window.navigator.vibrate(100);
      };

      // –í—ã–∑–≤–∞—Ç—å –¥—Ä—É–≥–∞ ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
      document.getElementById('challenge').onclick = () => {
        document.getElementById('betInput').style.display = 'block';
        document.getElementById('mainBtns').style.display = 'none';
      };

      // –û—Ç–º–µ–Ω–∞
      document.getElementById('cancelBet').onclick = () => {
        document.getElementById('betInput').style.display = 'none';
        document.getElementById('mainBtns').style.display = 'block';
        document.getElementById('betAmount').value = '';
      };

      // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Å—Ç–∞–≤–∫–∏
      document.getElementById('confirmBet').onclick = async () => {
        const betStr = document.getElementById('betAmount').value.trim();
        const bet = parseInt(betStr);

        if (!betStr || isNaN(bet) || bet < 10) {
          alert('–í–≤–µ–¥–∏—Ç–µ —Å—Ç–∞–≤–∫—É –æ—Ç 10 –º–æ–Ω–µ—Ç!');
          return;
        }
        if (bet > balance) {
          alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç!');
          return;
        }

        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–æ—Ä–æ—Ç–∫–∏–π ID –¥—É—ç–ª–∏ (8 —Å–∏–º–≤–æ–ª–æ–≤)
        const id = Math.random().toString(36).substring(2, 10);

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ Supabase
        const { error } = await supabase.from('duels').insert({
          id: id,
          player_a: userId,
          bet: bet,
          status: 'waiting'
        });

        if (error) {
          console.error('–û—à–∏–±–∫–∞ Supabase:', error);
          alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –¥—É—ç–ª—å. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
          return;
        }

        // –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
        const mention = user.username ? `@${user.username}` : user.first_name;
        const message = `${mention} –≤—ã–∑—ã–≤–∞–µ—Ç –Ω–∞ –¥—É—ç–ª—å! –°—Ç–∞–≤–∫–∞: ${bet} –º–æ–Ω–µ—Ç üé≤\n\n–ò–≥—Ä–∞—Ç—å: https://t.me/kostochki_game_bot?startapp=${id}`;

        // –ö–æ–ø–∏—Ä—É–µ–º ‚Äî —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç, –ø–æ—Ç–æ–º—É —á—Ç–æ –≤—ã–∑–≤–∞–Ω–æ –∏–∑ –∫–Ω–æ–ø–∫–∏
        navigator.clipboard.writeText(message).then(() => {
          alert('‚úÖ –°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!\n–û—Ç–ø—Ä–∞–≤—å—Ç–µ –µ—ë –¥—Ä—É–≥—É –≤ —á–∞—Ç.');
          document.getElementById('betInput').style.display = 'none';
          document.getElementById('mainBtns').style.display = 'block';
          document.getElementById('betAmount').value = '';
        }).catch(() => {
          // –ï—Å–ª–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–æ ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
          prompt('‚ùå –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤—Ä—É—á–Ω—É—é:', message);
          document.getElementById('betInput').style.display = 'none';
